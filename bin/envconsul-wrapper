#!/bin/bash
# Wraps a command in envconsul, if vault token is present

# Check for vault token from an init container.
if [ -f /vault/.vault-token ]; then
    vault_token=$(cat /vault/.vault-token)
    export VAULT_TOKEN=$vault_token
fi

function start() {
    if [ "$1" != "" ]; then
        cmd="$*"
        if [ -n "${VAULT_TOKEN}" ]; then
            echo "have token. wrapping ${cmd} with envconsul"
            start_envconsul
        else
            echo "Running $cmd"
            ${cmd}
        fi
    else
        echo "Missing Command Argument"
        exit 1
    fi
}


function start_envconsul() {
    set -u
    envconsul \
        -vault-addr="${VAULT_ADDR}" \
        -secret="${VAULT_PATH}" \
        -no-prefix=true \
        -vault-renew-token=true \
        -once \
        -exec="${cmd}"
}

start "$*"